HEALTHCARE ANALYTICS LAB - ETL DESIGN
ETL Strategy & Logic Documentation (Updated Implementation)
============================================

1. OVERVIEW & EXECUTION FLOW
-----------------------------
The data pipeline transforms normalized OLTP data into an optimized Star Schema.

Orchestration (Dockerized):
The pipeline uses strict sequential execution via `docker-compose` and numbered scripts to ensure idempotency and correctness.

Execution Order:
1. `01-oltp.sql`: Load Initial OLTP Data (10k records).
2. `02-oltp-increment.sql`: Simulate Incremental Data (Order +3k records).
3. `03-star-ddl.sql`: Deploy Star Schema DDL + Metadata Tables.
4. `04-star-etl.sql`: Execute Incremental ETL Logic.

============================================

2. DIMENSION LOAD LOGIC
-----------------------------

DIM_DATE (Dynamic Generation)
- Strategy: Stored Procedure (`populate_dim_date`)
- Logic: Replaced static CTEs with a flexible procedure taking `start_date` and `end_date`.
- Benefit: Allows generating future dates for forecasting without code changes.
- Attributes: 
  * `calendar_date`: Sequence date
  * `year`, `month`, `day`: Extracted functions
  * `quarter_name`: CONCAT('Q', QUARTER(dt))
  * `is_weekend`: CASE WHEN DAYOFWEEK IN (1,7) THEN TRUE
  * `is_holiday`: Placeholder for future logic

DIM_PATIENT (SCD Type 1/2)
- Strategy: Hybrid SCD
- Logic: Tracks history via `start_date`, `end_date`, and `is_current` flags.
- Transformation:
  * `age_group`: Hardcoded buckets (0-17, 18-34, etc.) for standardized reporting.

DIM_PROVIDER / SPECIALTY / DEPARTMENT
- Strategy: Denormalized & Type 1
- Logic: Flattens the OLTP snowflake (Specialty->Department) into the Provider dimension for single-join access.

============================================

3. FACT TABLE LOAD LOGIC (INCREMENTAL)
-----------------------------

Target: FACT_ENCOUNTERS
Source: OLTP `encounters`

Incremental Strategy: **Data-Driven High Watermark**
- Problem with Timestamp: Reliance on `inserted_at` can miss backfilled data.
- Solution: Track `high_watermark` based on the **Business Key** (Encounter Date).
  
Logic:
1. Retrieve Watermark: 
   `SELECT COALESCE(MAX(high_watermark), '1900-01-01') FROM etl_metadata`
2. Extract Delta:
   `SELECT * FROM encounters WHERE encounter_date > @last_watermark`
3. Load & Transform:
   - Denormalize metrics (Total Allowed Amount)
   - Lookup Surrogate Keys
4. Update Watermark:
   `UPDATE etl_metadata SET high_watermark = (SELECT MAX(encounter_datetime) FROM loaded_batch)`

Readmission Logic (Optimized):
- Instead of complex post-load updates, the system now uses optimized lookups.
- Logic: `is_readmission` flag is computed by checking for prior inpatient discharges within 30 days for the same patient.

============================================

4. BRIDGE TABLE LOAD LOGIC
-----------------------------

BRIDGE_ENCOUNTER_DIAGNOSES / PROCEDURES
- Strategy: Full Refresh (Current Implementation) / Append-Only (Target)
- Logic:
  - Links `encounter_key` to `diagnosis_key`.
  - Captures `sequence` (primary, secondary, etc.).
- Purpose: Efficiently models the Many-to-Many relationship without exploding the Fact table grain.

============================================

5. INFRASTRUCTURE & SCALABILITY
-----------------------------

Scalability Validated:
- The system was stress-tested with a 13.2k dataset (30% increase).
- **OLTP**: Showed fragility (latency tripled).
- **OLAP**: Scaled linearly (latency remained flat or grew proportionally).

Idempotency:
- The ETL script is designed to be re-runnable.
- `INSERT IGNORE` or `ON DUPLICATE KEY UPDATE` patterns prevent data duplication during re-runs.

5. SUMMARY DIMENSION (IMPLEMENTED)
---------------------------------------------

DIM_DIAGNOSIS_PROCEDURE_SUMMARY
- Type: Incrementally maintained summary dimension
- Purpose: Optimize Query 2 (Top Diagnosis-Procedure Pairs) performance
- Update Frequency: With each ETL batch (Section 3.5)

Implementation:
- Structure: Dimension table storing unique diagnosis-procedure pairs with aggregated metrics
- Metrics: encounter_count, total_revenue, avg_length_of_stay_days
- Key Attributes: icd10_code, icd10_description, cpt_code, cpt_description (denormalized for convenience)
- UPSERT Logic: ON DUPLICATE KEY UPDATE maintains running totals incrementally
- Performance: ~95% faster than bridge table joins (5-10ms vs 177ms)

Update Strategy:
1. Create temp table with new pairs from current ETL batch
2. UPSERT into summary dimension:
   - New pairs: INSERT with initial counts
   - Existing pairs: UPDATE with incremental counts using weighted average for LOS
3. Only processes encounters loaded in current batch (efficient)

Design Rationale:
Query 2 requires expensive 5-table join (fact → 2 bridges → 2 dimensions).
By maintaining a summary dimension:
  ✅ Eliminates bridge table joins at query time
  ✅ Pre-aggregates metrics during ETL (compute once, read many)
  ✅ Updates incrementally (no full rebuild needed)
  ✅ Provides conceptual clarity (dimension = descriptive reference data)
  ✅ Flexible querying (top 10, 20, 100 without schema changes)

Trade-offs:
  ⚠️ Storage: ~500KB for 10k unique pairs (negligible)
  ⚠️ ETL Time: +2-3 seconds per batch (acceptable)
  ⚠️ Complexity: UPSERT logic with weighted averages (moderate)

============================================

6. FUTURE OPTIMIZATIONS
---------------------------------------------
- **Partitioning**: Partition `fact_encounters` by `date_key` (Year-Month) for archival efficiency and faster historical queries.
- **Columnstore Indexes**: For MySQL 8.0+, consider columnstore indexes on fact tables for analytical workloads.
- **Additional Summary Dimensions**: Apply similar pattern to other common query patterns (e.g., provider-specialty-department combinations).